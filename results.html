<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interface d'export et de visualisation des colis</title>
    <link rel="stylesheet" href="results.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body>
    <h1>Gestion des Données IndexedDB</h1>
    <button id="loadDataBtn">Charger les données</button>
    <button id="exportBtn">Exporter vers Excel</button>
    <button id="exportZipBtn">Exporter sous forme de ZIP</button>
    <button id="deleteSelectedBtn">Supprimer les éléments sélectionnés</button>

    <table id="dataTable">
        <thead>
            <tr>
                <th><input type="checkbox" id="selectAll"></th>
                <th>ID</th>
                <th>Nom du destinataire</th>
                <th>Nom du réceptionnaire</th>
                <th>Email</th>
                <th>Nombre de colis</th>
                <th>Date</th>
                <th>Signature</th>
                <th>Photos</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <script>
        const dbName = "ReceptionDB";
        let db;

        // Initialiser IndexedDB
        const openDB = () => {
            const request = indexedDB.open(dbName, 1);

            request.onupgradeneeded = (event) => {
                db = event.target.result;

                if (!db.objectStoreNames.contains("receptions")) {
                    const objectStore = db.createObjectStore("receptions", {
                        keyPath: "id",
                        autoIncrement: true,
                    });
                    objectStore.createIndex("email", "email", { unique: false });
                }
            };

            request.onsuccess = (event) => {
                db = event.target.result;
                console.log("Base IndexedDB prête !");
            };

            request.onerror = (event) => {
                console.error("Erreur avec IndexedDB :", event.target.error);
            };
        };

        openDB();

        // Charger les données
        const loadData = () => {
            const transaction = db.transaction(["receptions"], "readonly");
            const objectStore = transaction.objectStore("receptions");
            const request = objectStore.getAll();

            request.onsuccess = () => {
                const data = request.result;
                const tbody = document.getElementById("dataTable").querySelector("tbody");
                tbody.innerHTML = "";

                data.forEach((item) => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td class="checkbox"><input type="checkbox" class="selectRow" data-id="${item.id}"></td>
                        <td>${item.id}</td>
                        <td>${item.recipientName}</td>
                        <td>${item.receiverName}</td>
                        <td>${item.email}</td>
                        <td>${item.packageCount}</td>
                        <td>${item.deliveryDate}</td>
                        <td><img src="${item.signature || ''}" alt="Signature"></td>
                        <td>${(item.photos || []).map(
                            (photo) => `<img src="${photo}" alt="Photo" title="Photo">`
                        ).join(" ")}</td>
                    `;
                    tbody.appendChild(row);
                });

                alert("Données chargées avec succès !");
            };

            request.onerror = (event) => {
                console.error("Erreur lors du chargement des données :", event.target.error);
            };
        };

        // Supprimer les éléments sélectionnés
        const deleteSelected = () => {
            const checkboxes = document.querySelectorAll(".selectRow:checked");
            if (checkboxes.length === 0) {
                alert("Aucun élément sélectionné !");
                return;
            }

            const idsToDelete = Array.from(checkboxes).map((checkbox) => Number(checkbox.dataset.id));
            const transaction = db.transaction(["receptions"], "readwrite");
            const objectStore = transaction.objectStore("receptions");

            idsToDelete.forEach((id) => {
                const request = objectStore.delete(id);

                request.onsuccess = () => {
                    console.log(`Élément avec ID ${id} supprimé.`);
                };

                request.onerror = (event) => {
                    console.error(`Erreur lors de la suppression de l'élément avec ID ${id} :`, event.target.error);
                };
            });

            transaction.oncomplete = () => {
                alert("Éléments sélectionnés supprimés avec succès !");
                loadData();
            };
        };

        // Exporter les données au format Excel
        const exportToExcel = () => {
            const transaction = db.transaction(["receptions"], "readonly");
            const objectStore = transaction.objectStore("receptions");
            const request = objectStore.getAll();

            request.onsuccess = () => {
                const data = request.result;

                // Créer des données Excel à partir des données
                const excelData = data.map((item) => ({
                    ID: item.id,
                    Destinataire: item.recipientName,
                    Réceptionnaire: item.receiverName,
                    Email: item.email,
                    "Nombre de colis": item.packageCount,
                    Date: item.deliveryDate,
                    Signature: "Signature incluse",
                    Photos: `Photos incluses (${item.photos.length})`,
                }));

                // Convertir en feuille Excel
                const worksheet = XLSX.utils.json_to_sheet(excelData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Receptions");

                // Générer et télécharger le fichier Excel
                XLSX.writeFile(workbook, "Données_Reception.xlsx");
                alert("Fichier Excel exporté avec succès !");
            };

            request.onerror = (event) => {
                console.error("Erreur lors de l'exportation :", event.target.error);
            };
        };


        // Exporter les données au format ZIP
        const exportToZip = async () => {
            const exportButton = document.getElementById("exportZipBtn");
            exportButton.disabled = true;
            exportButton.textContent = "Exportation en cours...";

            const transaction = db.transaction(["receptions"], "readonly");
            const objectStore = transaction.objectStore("receptions");
            const request = objectStore.getAll();

            request.onsuccess = async () => {
                const data = request.result;

                if (data.length === 0) {
                    alert("Aucune donnée à exporter !");
                    exportButton.disabled = false;
                    exportButton.textContent = "Exporter sous forme de ZIP";
                    return;
                }

                const zip = new JSZip();

                for (const item of data) {
                    const folder = zip.folder(`ligne_${item.id}`);
                    
                    const jsonContent = {
                        id: item.id,
                        recipientName: item.recipientName,
                        receiverName: item.receiverName,
                        email: item.email,
                        packageCount: item.packageCount,
                        deliveryDate: item.deliveryDate,
                    };
                    folder.file("info.json", JSON.stringify(jsonContent, null, 2));

                    // Convertir les images et signatures en blobs
                    const addBlobToFolder = async (url, fileName) => {
                        try {
                            if (url.startsWith("data:")) {
                                const base64toBlob = (base64, type = "image/jpeg") => {
                                    const binary = atob(base64.split(",")[1]);
                                    const array = [];
                                    for (let i = 0; i < binary.length; i++) {
                                        array.push(binary.charCodeAt(i));
                                    }
                                    return new Blob([new Uint8Array(array)], { type });
                                };
                                const blob = base64toBlob(url);
                                folder.file(fileName, blob);
                            } else {
                                const response = await fetch(url);
                                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                                const blob = await response.blob();
                                folder.file(fileName, blob);
                            }
                        } catch (error) {
                            console.error(`Erreur lors du téléchargement de ${fileName} :`, error);
                        }
                    };

                    for (let i = 0; i < (item.photos || []).length; i++) {
                        await addBlobToFolder(item.photos[i], `photo_${i + 1}.jpg`);
                    }

                    if (item.signature) {
                        await addBlobToFolder(item.signature, "signature.jpg");
                    }
                }

                zip.generateAsync({ type: "blob" }).then((content) => {
                    saveAs(content, "Données_Reception.zip");
                    alert("Fichier ZIP exporté avec succès !");
                }).catch((error) => {
                    console.error("Erreur lors de la génération du fichier ZIP :", error);
                    alert("Une erreur s'est produite lors de l'exportation ZIP.");
                }).finally(() => {
                    exportButton.disabled = false;
                    exportButton.textContent = "Exporter sous forme de ZIP";
                });
            };

            request.onerror = (event) => {
                console.error("Erreur lors de l'exportation ZIP :", event.target.error);
                exportButton.disabled = false;
                exportButton.textContent = "Exporter sous forme de ZIP";
            };
        };

        // Ajouter les écouteurs
        document.getElementById("loadDataBtn").addEventListener("click", loadData);
        document.getElementById("deleteSelectedBtn").addEventListener("click", deleteSelected);
        document.getElementById("selectAll").addEventListener("click", () => {
            const selectAllCheckbox = document.getElementById("selectAll");
            const checkboxes = document.querySelectorAll(".selectRow");
            checkboxes.forEach((checkbox) => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        });
        document.getElementById("exportZipBtn").addEventListener("click", exportToZip);
        document.getElementById("exportBtn").addEventListener("click", exportToExcel);
    </script>
</body>
</html>
