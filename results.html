<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interface IndexedDB</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f4f4f9;
        }

        h1 {
            text-align: center;
            color: #333;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: #fff;
        }

        table th, table td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: center;
        }

        table th {
            background: #007BFF;
            color: #fff;
        }

        img {
            max-width: 100px;
            max-height: 100px;
        }

        button {
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin: 10px 0;
        }

        button:hover {
            background: #218838;
        }

        #exportBtn {
            background: #007bff;
        }

        #exportBtn:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <h1>Gestion des Données IndexedDB</h1>
    <button id="loadDataBtn">Charger les données</button>
    <button id="exportBtn">Exporter vers Excel</button>
    <table id="dataTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Nom du destinataire</th>
                <th>Nom du réceptionnaire</th>
                <th>Email</th>
                <th>Nombre de colis</th>
                <th>Date</th>
                <th>Signature</th>
                <th>Photos</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <script>
        const dbName = "ReceptionDB";
        let db;

        // Initialiser IndexedDB
        const openDB = () => {
            const request = indexedDB.open(dbName, 1);

            request.onupgradeneeded = (event) => {
                db = event.target.result;

                // Créer l'object store si nécessaire
                if (!db.objectStoreNames.contains("receptions")) {
                    const objectStore = db.createObjectStore("receptions", {
                        keyPath: "id",
                        autoIncrement: true,
                    });
                    objectStore.createIndex("email", "email", { unique: false });
                }
            };

            request.onsuccess = (event) => {
                db = event.target.result;
                console.log("Base IndexedDB prête !");
            };

            request.onerror = (event) => {
                console.error("Erreur avec IndexedDB :", event.target.error);
            };
        };

        openDB();

        // Charger les données depuis IndexedDB
        const loadData = () => {
            const transaction = db.transaction(["receptions"], "readonly");
            const objectStore = transaction.objectStore("receptions");
            const request = objectStore.getAll();

            request.onsuccess = () => {
                const data = request.result;
                const tbody = document.getElementById("dataTable").querySelector("tbody");
                tbody.innerHTML = ""; // Réinitialiser le tableau

                data.forEach((item) => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${item.id}</td>
                        <td>${item.recipientName}</td>
                        <td>${item.receiverName}</td>
                        <td>${item.email}</td>
                        <td>${item.packageCount}</td>
                        <td>${item.deliveryDate}</td>
                        <td>
                            <img src="${item.signature}" alt="Signature">
                        </td>
                        <td>
                            ${item.photos
                                .map(
                                    (photo) =>
                                        `<img src="${photo}" alt="Photo" title="Photo">`
                                )
                                .join(" ")}
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                alert("Données chargées avec succès !");
            };

            request.onerror = (event) => {
                console.error("Erreur lors du chargement des données :", event.target.error);
            };
        };

        // Exporter les données au format Excel
        const exportToExcel = () => {
            const transaction = db.transaction(["receptions"], "readonly");
            const objectStore = transaction.objectStore("receptions");
            const request = objectStore.getAll();

            request.onsuccess = () => {
                const data = request.result;

                // Créer des données Excel à partir des données
                const excelData = data.map((item) => ({
                    ID: item.id,
                    Destinataire: item.recipientName,
                    Réceptionnaire: item.receiverName,
                    Email: item.email,
                    "Nombre de colis": item.packageCount,
                    Date: item.deliveryDate,
                    Signature: "Signature incluse",
                    Photos: `Photos incluses (${item.photos.length})`,
                }));

                // Convertir en feuille Excel
                const worksheet = XLSX.utils.json_to_sheet(excelData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Receptions");

                // Générer et télécharger le fichier Excel
                XLSX.writeFile(workbook, "Données_Reception.xlsx");
                alert("Fichier Excel exporté avec succès !");
            };

            request.onerror = (event) => {
                console.error("Erreur lors de l'exportation :", event.target.error);
            };
        };

        // Écouteurs d'événements
        document.getElementById("loadDataBtn").addEventListener("click", loadData);
        document.getElementById("exportBtn").addEventListener("click", exportToExcel);
    </script>
</body>
</html>
