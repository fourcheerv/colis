<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau des données</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <h1>Tableau des données sauvegardées</h1>
    <div>
        <input type="text" id="searchBox" placeholder="Rechercher par email ou nom">
        <button id="clearSearch">Réinitialiser</button>
    </div>
    <table id="dataTable">
        <thead>
            <tr>
                <th>Sélection</th>
                <th>Nom Destinataire</th>
                <th>Nom Réceptionnaire</th>
                <th>Nombre de Colis</th>
                <th>Email</th>
                <th>Date de Réception</th>
                <th>Livré</th>
                <th>Signature</th>
                <th>Photos</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <div id="pagination">
        <button id="prevPage">Précédent</button>
        <span id="pageIndicator"></span>
        <button id="nextPage">Suivant</button>
    </div>
    <button id="deleteSelected">Supprimer les éléments sélectionnés</button>
    <button id="exportExcel">Exporter en Excel</button>
    <button id="exportZip">Exporter en ZIP</button>

    <script>
        const dbName = "ReceptionDB";
        let db;
        const rowsPerPage = 10;
        let currentPage = 1;
        let filteredData = []; // Pour stocker les résultats filtrés

        const openDB = () => {
            const request = indexedDB.open(dbName, 1);
            request.onsuccess = (event) => {
                db = event.target.result;
                loadTableData();
            };
            request.onerror = (event) => {
                console.error("Erreur avec IndexedDB :", event.target.error);
            };
        };

        const loadTableData = () => {
            const transaction = db.transaction(["receptions"], "readonly");
            const objectStore = transaction.objectStore("receptions");

            const data = [];
            objectStore.openCursor().onsuccess = (event) => {
                const cursor = event.target.result;
                if (cursor) {
                    data.push(cursor.value);
                    cursor.continue();
                } else {
                    filteredData = data;
                    renderTable(filteredData);
                }
            };
        };

        const renderTable = (data) => {
            const tableBody = document.querySelector("#dataTable tbody");
            tableBody.innerHTML = "";

            const start = (currentPage - 1) * rowsPerPage;
            const paginatedData = data.slice(start, start + rowsPerPage);

            paginatedData.forEach((item) => {
                const row = document.createElement("tr");

                row.innerHTML = `
                    <td><input type="checkbox" class="row-select" data-id="${item.id}"></td>
                    <td>${item.recipientName}</td>
                    <td>${item.receiverName}</td>
                    <td>${item.packageCount}</td>
                    <td>${item.email}</td>
                    <td>${item.deliveryDate}</td>
                    <td>${item.delivered === "true" ? "Oui" : "Non"}</td>
                    <td><a href="${item.signature}" target="_blank">Voir</a></td>
                    <td>${item.photos.map((photo, index) => `<a href="${photo}" target="_blank">Photo ${index + 1}</a>`).join(", ")}</td>
                `;

                tableBody.appendChild(row);
            });

            updatePagination(data.length);
        };

        const updatePagination = (totalRows) => {
            const pageIndicator = document.getElementById("pageIndicator");
            const prevPage = document.getElementById("prevPage");
            const nextPage = document.getElementById("nextPage");

            const totalPages = Math.ceil(totalRows / rowsPerPage);
            pageIndicator.textContent = `Page ${currentPage} sur ${totalPages}`;

            prevPage.disabled = currentPage === 1;
            nextPage.disabled = currentPage === totalPages;
        };

        const handlePagination = (direction) => {
            currentPage += direction;
            renderTable(filteredData);
        };

        document.getElementById("prevPage").addEventListener("click", () => handlePagination(-1));
        document.getElementById("nextPage").addEventListener("click", () => handlePagination(1));

        // Rechercher dans les données
        document.getElementById("searchBox").addEventListener("input", (event) => {
            const query = event.target.value.toLowerCase();
            filteredData = query
                ? filteredData.filter(
                      (item) =>
                          item.email.toLowerCase().includes(query) ||
                          item.recipientName.toLowerCase().includes(query)
                  )
                : filteredData;

            currentPage = 1;
            renderTable(filteredData);
        });

        document.getElementById("clearSearch").addEventListener("click", () => {
            document.getElementById("searchBox").value = "";
            loadTableData();
        });

        // Supprimer les éléments sélectionnés
        document.getElementById("deleteSelected").addEventListener("click", () => {
            const selectedCheckboxes = document.querySelectorAll(".row-select:checked");
            if (selectedCheckboxes.length === 0) {
                alert("Aucune ligne sélectionnée !");
                return;
            }

            const transaction = db.transaction(["receptions"], "readwrite");
            const objectStore = transaction.objectStore("receptions");

            selectedCheckboxes.forEach((checkbox) => {
                const id = parseInt(checkbox.dataset.id, 10);
                objectStore.delete(id);
            });

            transaction.oncomplete = () => {
                alert("Éléments supprimés !");
                loadTableData();
            };
        });

        // Exporter les données en Excel
        document.getElementById("exportExcel").addEventListener("click", () => {
            const worksheetData = filteredData.map((item) => ({
                "Nom Destinataire": item.recipientName,
                "Nom Réceptionnaire": item.receiverName,
                "Nombre de Colis": item.packageCount,
                Email: item.email,
                "Date de Réception": item.deliveryDate,
                Livré: item.delivered === "true" ? "Oui" : "Non",
            }));

            const worksheet = XLSX.utils.json_to_sheet(worksheetData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Données");
            XLSX.writeFile(workbook, "reception_data.xlsx");
        });

        // Exporter les données en ZIP
        document.getElementById("exportZip").addEventListener("click", async () => {
            const zip = new JSZip();

            filteredData.forEach((item) => {
                zip.file(`${item.id}_signature.jpeg`, item.signature.split(",")[1], { base64: true });

                item.photos.forEach((photo, index) => {
                    zip.file(`${item.id}_photo_${index + 1}.jpeg`, photo.split(",")[1], { base64: true });
                });
            });

            const content = await zip.generateAsync({ type: "blob" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(content);
            link.download = "reception_data.zip";
            link.click();
        });

        openDB();
    </script>
</body>
</html>
